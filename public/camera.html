<!-- ... (styles and HTML unchanged) ... -->
<script>
const video = document.getElementById('video');
const startBtn = document.getElementById('start-btn');
const stopBtn = document.getElementById('stop-btn');
const manualBtn = document.getElementById('manual-btn');
const errorMsg = document.getElementById('error-msg');
let stream;
let captureInterval;

async function startCamera() {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { exact: "environment" }, width: { ideal: 640 }, height: { ideal: 480 } }, audio: false // Limit resolution
    });
  } catch (e) {
    console.error('Camera error:', e);
    errorMsg.textContent = 'Camera access failed. Check permissions.';
    errorMsg.style.display = 'block';
    // Fallback
    stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 640 }, height: { ideal: 480 } }, audio: false });
  }
  video.srcObject = stream;
}
startCamera();

async function captureAndSend() {
  if (!video.videoWidth || video.videoWidth === 0) {
    console.error('Video not ready');
    errorMsg.textContent = 'Video stream not ready. Wait a moment.';
    errorMsg.style.display = 'block';
    return;
  }
  const canvas = document.createElement('canvas');
  canvas.width = Math.min(640, video.videoWidth); // Cap at 640px
  canvas.height = (video.videoHeight / video.videoWidth) * canvas.width;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  canvas.toBlob(async (blob) => {
    if (blob.size > 5 * 1024 * 1024) { // Client-side size check
      errorMsg.textContent = 'Image too large. Try a clearer shot.';
      errorMsg.style.display = 'block';
      return;
    }
    const formData = new FormData();
    formData.append('image', blob, 'frame.jpg');
    try {
      const response = await fetch('/upload', { 
        method: 'POST', 
        body: formData,
        signal: AbortSignal.timeout(45000) // 45s client timeout
      });
      const data = await response.json();
      if (!response.ok) {
        const details = data.details ? `: ${data.details}` : '';
        throw new Error(`${data.error || 'Upload failed'}${details}`);
      }
      console.log('Upload success:', data);
      errorMsg.style.display = 'none';
      manualBtn.disabled = false;
      manualBtn.textContent = "Take Photo Now";
    } catch (e) {
      console.error('Error uploading image:', e);
      errorMsg.textContent = `Upload error: ${e.message}`;
      errorMsg.style.display = 'block';
      manualBtn.disabled = false;
      manualBtn.textContent = "Take Photo Now";
    }
  }, 'image/jpeg', 0.7); // 70% quality
}

// Event handlers unchanged
startBtn.onclick = function () {
  if (captureInterval) clearInterval(captureInterval);
  captureAndSend();
  captureInterval = setInterval(captureAndSend, 15000);
};
stopBtn.onclick = function () {
  if (captureInterval) clearInterval(captureInterval);
};
manualBtn.onclick = function () {
  manualBtn.textContent = "Sending...";
  manualBtn.disabled = true;
  errorMsg.style.display = 'none';
  captureAndSend();
};
</script>
</body>
</html>